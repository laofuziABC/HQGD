<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>和其光电</title>
<!-- Tell the browser to be responsive to screen width -->
<meta
	content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
	name="viewport">
<!-- Bootstrap 3.3.7 -->
<link rel="stylesheet"
	href="bower_components/bootstrap/dist/css/bootstrap.min.css">
<!-- Font Awesome -->
<link rel="stylesheet"
	href="bower_components/font-awesome/css/font-awesome.min.css">
<!-- Ionicons -->
<link rel="stylesheet"
	href="bower_components/Ionicons/css/ionicons.min.css">
<!-- jvectormap -->
<link rel="stylesheet"
	href="bower_components/jvectormap/jquery-jvectormap.css">
<!-- Theme style -->
<link rel="stylesheet" href="dist/css/AdminLTE.min.css">
<!-- AdminLTE Skins. Choose a skin from the css/skins folder instead of downloading all of them to reduce the load. -->
<link rel="stylesheet" href="dist/css/skins/_all-skins.min.css">
<!-- Google Font -->
<link rel="stylesheet"
	href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,300italic,400italic,600italic">
</head>
<body class="hold-transition skin-blue sidebar-mini">
	<div class="wrapper">
		<!-- 页面顶部标题【开始】 -->
		<header class="main-header" id="main-header"> </header>
		<!-- 页面顶部标题【结束】 -->
		<!-- 侧边栏【开始】 -->
		<aside class="main-sidebar" id="main-sidebar">
			<section class="sidebar">
				<ul class="sidebar-menu" data-widget="tree">
					<li class="header">菜单栏</li>
					<li><a href="#" onclick="javascript: window.history.go(0);"
						style="margin-top: 10px;"> <i class="fa fa-home"
							style="font-size: 22px"></i> <span>首页</span>
					</a></li>
					<li><a href="#"
						onclick="loadMainContent('childrenHtml/content/ssjc.html');">
							<i class="fa fa-line-chart"></i> <span>数据监测</span>
					</a></li>
					<!-- <li class="manager"><a href="#"
						onclick="loadMainContent('childrenHtml/equipment/connectMonitor.html');">
							<i class="fa fa-unlink"></i> <span>通信监测</span>
					</a></li>  -->
					<li><a href="#"
						onclick="loadMainContent('childrenHtml/equipment/equipmentList.html');">
							<i class="fa fa-gears"></i> <span>设备管理</span>
					</a></li>
					<!-- <li class="manager"><a href="#"
						onclick="loadMainContent('childrenHtml/equipment/routerList.html');">
							<i class="fa fa-wifi"></i> <span>路由器管理</span>
					</a></li> -->
					<!-- 管理员菜单manager -->
					<li class="manager"><a href="#"
						onclick="loadMainContent('childrenHtml/user/userList.html');">
							<i class="fa fa-user"></i> <span>用户管理</span>
					</a></li>
					<li class="treeview"><a href="#"> <i class="fa fa-sliders"></i>
							<span>系统集成</span> <span class="pull-right-container"><i
								class="fa fa-angle-left pull-right"></i></span>
					</a>
						<ul class="treeview-menu">
							<!-- <li><a href="#" onclick="network();"><i
									class="fa fa-bookmark"></i><span>图形设计</span></a></li> -->
							<!-- <li><a href="#"
								onclick="loadMainContent('childrenHtml/operationalMonitoring/update.html');">
									<i class="fa fa fa-bookmark"></i> 上传图例
							</a></li> -->
							<li><a href="#"
								onclick="loadMainContent('childrenHtml/system/system.html');">
									<i class="fa fa-bookmark"></i> 系统参数
							</a></li>
						</ul></li>

					<!-- 微信二维码（图片） -->
					<li><img id="sidebar-footer" src="vince/images/QRcode.jpg"
						style="position: fixed; bottom: 0; width: 200px; height: 200px; padding: 20px;"
						alt="Logo"></li>
				</ul>
			</section>
		</aside>
		<!-- 侧边栏【结束】 -->
		<div id="content-wrapper">
			<!-- Main content -->
			<section class="content" style="background: #ecf0f5;">
				<div id="mapContainer" class="map" tabindex="0"></div>
			</section>
		</div>
		<div id="updatepass"></div>
		<footer class="main-footer">
			<strong>Copyright &copy; 2018-2028 
				<a href="http://www.optsensor.com">Optsensor</a>.
			</strong> All rights reserved.
			<strong>v1.0.0</strong>
		</footer>

		<!-- Control Sidebar -->
		<aside class="control-sidebar control-sidebar-dark">
			<!-- Create the tabs -->
			<ul class="nav nav-tabs nav-justified control-sidebar-tabs">
				<li><a href="#control-sidebar-home-tab" data-toggle="tab"><i
						class="fa fa-home"></i></a></li>
				<li><a href="#control-sidebar-settings-tab" data-toggle="tab"><i
						class="fa fa-gears"></i></a></li>
			</ul>
			<!-- Tab panes -->
			<div class="tab-content"></div>
		</aside>
		<!-- Add the sidebar's background. This div must be placed immediately after the control sidebar -->
		<div class="control-sidebar-bg"></div>
	</div>

	<!-- jQuery 3 -->
	<!-- <script src="bower_components/jquery/dist/jquery.min.js"></script> -->
	<script src="plugins/jQuery/jquery-2.2.3.min.js"></script>
	<!-- Bootstrap 3.3.7 -->
	<script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
	<!-- FastClick -->
	<script src="bower_components/fastclick/lib/fastclick.js"></script>
	<!-- AdminLTE App -->
	<!-- <script src="dist/js/adminlte.min.js"></script> -->
	<script src="dist/js/adminlte.js"></script>
	<!-- Sparkline -->
	<script
		src="bower_components/jquery-sparkline/dist/jquery.sparkline.min.js"></script>
	<!-- jvectormap  -->
	<script src="plugins/jvectormap/jquery-jvectormap-1.2.2.min.js"></script>
	<script src="plugins/jvectormap/jquery-jvectormap-world-mill-en.js"></script>
	<!-- SlimScroll -->
	<script
		src="bower_components/jquery-slimscroll/jquery.slimscroll.min.js"></script>
	<!-- AdminLTE for demo purposes -->
	<script src="dist/js/demo.js"></script>
	<script src="vince/drag/zxx.drag.1.0.js"></script>
	<!-- 在主页面引入HighCharts插件 -->
	<script type="text/javascript" src="dist/js/chart/highcharts.js"></script>
	<script type="text/javascript" src="dist/js/chart/high-chart.js"></script>

	<script src="dist/js/jquery.table2excel.js"></script>
	<script type="text/javascript">
			//获取页面参数【开始】
			function getParam(string) {
			    var reg = new RegExp("(^|&)" + string + "=([^&]*)(&|$)", "i");  
			    var l = decodeURI(window.location.search);
			    var r = l.substr(1).match(reg);
			    if (r != null){
			    	var result = decodeURI(r[2]);
			    	return unescape(result);
			    }
			}
			//获取页面参数【结束】
			function updatePass() {
				$("#updatepass").load("childrenHtml/updatepass.html");
			}
			function updatePass1() {
				$("#updatepass").empty();
			}
			//组装时间：将时间转化成“yyyy-MM-dd HH:mm:ss”格式的字符串【开始】
			function formatTimeToString(param){
				var y = param.getFullYear();
				var M = unifiedFormat(param.getMonth()+1);
				var d = unifiedFormat(param.getDate());
				var H = unifiedFormat(param.getHours());
				var m = unifiedFormat(param.getMinutes());
				var s = unifiedFormat(param.getSeconds());
				var result = y+"-"+M+"-"+d+" "+H+":"+m+":"+s;
				return result;
			}
			function formatDateToString(param){
				var y = param.getFullYear();
				var M = unifiedFormat(param.getMonth()+1);
				var d = unifiedFormat(param.getDate());
				var result = y+"-"+M+"-"+d;
				return result;
			}
			function unifiedFormat(param){
				return (param<10)?("0"+param):param;
			}
			//组装时间：将时间转化成“yyyy-MM-dd HH:mm:ss”格式的字符串【结束】
			//根据用户角色，加载用户菜单【开始】
			var roleId =getParam("roleId");
			var userName =getParam("userName");
			$("#main-header").load("childrenHtml/title.html");
			//$("#main-sidebar").load("childrenHtml/side-menu.html");
			var managerMenu=document.getElementsByClassName("manager");
			var customerMenu=document.getElementsByClassName("customer");
			for(let i=0; i<managerMenu.length; i++){
				managerMenu[i].style.display=(roleId==1)?"block":"none";
			}
			for(let i=0; i<customerMenu.length; i++){
				customerMenu[i].style.display=(roleId!=1)?"block":"none";
			}
			/* $(function(){
				if(roleId=="0"){
					$("#main-sidebar").load("childrenHtml/side-menu1.html");
				}else{
					$("#main-sidebar").load("childrenHtml/side-menu.html");
				}
				//$("#main-header").load("childrenHtml/title.html");
			}); */
			//根据用户角色，加载用户菜单【结束】
			//关联菜单和页面
			var stompClient = null;
			function loadMainContent(param) {
				if($("body").hasClass("sidebar-open")){
					$(".sidebar-toggle").click();
				}
				if (param != null) {
					if (stompClient != null) {
						stompClient.disconnect();
						stompClient = null;
					}
					$("#content-wrapper").load(param);
				}
			}
			//小屏幕指定菜单选择后隐藏
			$(".selection>li").on("click",function(){
				if($("body").hasClass("sidebar-open")){
					$(".sidebar-toggle").click();
				}
			});
		</script>
	<!-- 页面地图【开始】 -->
	<script type="text/javascript"
		src="https://webapi.amap.com/maps?v=1.4.11&key=f6ee07ce6b36ef10876b7d1ed533dadc&plugin=AMap.MarkerClusterer">
		</script>
	<script src="//webapi.amap.com/ui/1.0/main.js?v=1.0.11"></script>
	<script type="text/javascript">
			//设定高度适应屏幕高度【开始】
			var myWindow=document.getElementById("mapContainer");
			var screenHeight = window.screen.availHeight;
			var screenWidth = window.screen.availWidth;
			myWindow.style.width=screenWidth+"px";
			myWindow.style.height=screenHeight+"px";
			//设定高度适应屏幕高度【结束】
			AMapUI.loadUI(['overlay/SimpleInfoWindow'], function(SimpleInfoWindow) {
			var cluster, markers = [];
		    var points= [];
		    var map = new AMap.Map("mapContainer", {
		    	mapStyle: 'amap://styles/normal',
		        resizeEnable: true,
		        center: [105, 32],
		        zoom: 5
		    });
		    getLngLat();
		    
		    function getLngLat(){
		    	$.ajax({
					url:"map/getPositions",
					type:"post",
					data : {
						"userName" : userName,
						"roleId" : roleId
					},
					async:false,
					dataType: "json",
					success: function(result){
						points = result.data;
					}
				});
		    }
		    	
		    /* for (var i = 0; i < points.length; i += 1) { */
		    $.each(points, function(i, item) { 	
		    	var marker = new AMap.Marker({
		            position: points[i].lngLat.split(','),
		            content: '<div style="background-color: hsla(180, 100%, 50%, 0.7); height: 24px; width: 24px; border: 1px solid hsl(180, 100%, 40%); border-radius: 12px; box-shadow: hsl(180, 100%, 50%) 0px 0px 1px;"></div>',
		            offset: new AMap.Pixel(-15, -15)
		        })
		    	var equiId = item.equipmentId; 
		    	var equiName = item.equipmentName;
		    	addClickHandler(equiId, equiName,marker); //添加点击事件
		        markers.push(marker);
		    });
		    
		    var count = markers.length;
		    var _renderCluserMarker = function (context) {
		    	var factor = Math.pow(context.count / count, 1 / 18);
		        var div = document.createElement('div');
		        var Hue = 180 - factor * 180;
		        var bgColor = 'hsla(' + Hue + ',100%,50%,0.7)';
		        var fontColor = 'hsla(' + Hue + ',100%,20%,1)';
		        var borderColor = 'hsla(' + Hue + ',100%,40%,1)';
		        var shadowColor = 'hsla(' + Hue + ',100%,50%,1)';
		        div.style.backgroundColor = bgColor;
		        var size = Math.round(30 + Math.pow(context.count / count, 1 / 5) * 20);
		        div.style.width = div.style.height = size/2 + 'px';
		        div.style.border = 'solid 1px ' + borderColor;
		        div.style.borderRadius = size / 2 + 'px';
		        div.style.boxShadow = '0 0 1px ' + shadowColor;
		        div.innerHTML = context.count;
		        div.style.lineHeight = size/2 + 'px';
		        div.style.color = fontColor;
		        div.style.fontSize = '14px';
		        div.style.textAlign = 'center';
		        context.marker.setOffset(new AMap.Pixel(-size / 2, -size / 2));
		        context.marker.setContent(div)
		    };
		    addCluster(2);
	
		    function addCluster(tag) {
		        if (cluster) {
		            cluster.setMap(null);
		        }
		        if (tag == 2) {//完全自定义
		            cluster = new AMap.MarkerClusterer(map, markers, {
		                gridSize: 80,
		                maxZoom:17,
		                renderCluserMarker: _renderCluserMarker
		            });
		        }else if (tag == 1) {//自定义图标
	            var sts = [{
	                url: "https://a.amap.com/jsapi_demos/static/images/blue.png",
	                size: new AMap.Size(32, 32),
	                offset: new AMap.Pixel(-16, -16)
	            }, {
	                url: "https://a.amap.com/jsapi_demos/static/images/green.png",
	                size: new AMap.Size(32, 32),
	                offset: new AMap.Pixel(-16, -16)
	            }, {
	                url: "https://a.amap.com/jsapi_demos/static/images/orange.png",
	                size: new AMap.Size(36, 36),
	                offset: new AMap.Pixel(-18, -18)
	            }, {
	                url: "https://a.amap.com/jsapi_demos/static/images/red.png",
	                size: new AMap.Size(48, 48),
	                offset: new AMap.Pixel(-24, -24)
	            }, {
	                url: "https://a.amap.com/jsapi_demos/static/images/darkRed.png",
	                size: new AMap.Size(48, 48),
	                offset: new AMap.Pixel(-24, -24)
	            }];
	            cluster = new AMap.MarkerClusterer(map, markers, {
	                styles: sts,
	                gridSize: 80
	            });
	        } else {//默认样式
	            cluster = new AMap.MarkerClusterer(map, markers, {gridSize: 80});
	        }
	    }
		    /* var infoWindow = new SimpleInfoWindow({
		    	infoTitle: '<strong>实时温度</strong>',
	            infoBody: '<p class="my-desc"></p>',
	            //基点指向marker的头部位置
	            offset: new AMap.Pixel(0, -31)
	        }); */
		    function addClickHandler(equiId,equiName,marker){
		    	marker.on("click",function(e){
		    	openInfo(equiId,equiName,marker,e)}
		    	);
		    	}
		    function openInfo(equiId,equiName,marker,e){
		    	var channel = "";
		    	$.ajax({
					url : "dataAcquisition/realtime",
					type : "post",
					data : {
						"equipmentId" : equiId
					},
					dataType : "json",
					success : function(data) {
						if(data.length==0){
							channel+="<h5 style='color: red;'>未查找到通道监测信息！</h5>"; 
						}else{
							var num =data.length;
							//超过5分钟提示
							lTime=(new Date(data[0].receiveTime)).getTime();
							cTime=(new Date()).getTime();
							$("#last-time").text("最后监测时间："+data[0].receiveTime);
							if((cTime-lTime)>(5*60*1000)){ $("#last-time").css({"color":"red"}); }
							else{$("#last-time").css({"color":"#21242e"});}
							//设定尺寸适应容器【开始】
							let count = Math.ceil(num/3);
							//设定尺寸适应容器【结束】
							for(let i=0; i<count; i++){
								let startIndex = 3*i;
								let endIndex = (3*i+3>num)?num:(3*i+3);
								channel+="<tr>";
								//通道结果每三个循环一回，缘于界面展示效果较规整
								for(let j=startIndex; j<endIndex; j++){
									let state=parseFloat(data[j].state);
									if(state==5){
										var resultMsg=(data[j].temperature==2999)?("系统调整中"):(data[j].temperature);
										channel+="<td class='green' style='padding: 10px;'><span class='span_left'>"+data[j].opticalFiberPosition+"：</span><span class='span_right'>"+resultMsg+"</span></td>"; 
									}
									else if(state==4){channel+="<td class='red' style=' padding: 10px;'><span class='span_left'>"+data[j].opticalFiberPosition+"：</span><span class='span_right'>- - - - -</span></td>"; }
									else if(state==3){channel+="<td class='red' style='padding: 10px;'><span class='span_left'>"+data[j].opticalFiberPosition+"：</span><span class='span_right'>- - -</span></td>"; }
									else{channel+="<td class='yellow' style='padding: 10px;'><span class='span_left'>"+data[j].opticalFiberPosition+"：</span><span class='span_right'>"+data[j].temperature+"</span></td>"; }
								}
								channel+="</tr>";
							}
						}
						$("#chwin").html(channel);
					}
					
				});
		    	new SimpleInfoWindow({
			    	infoTitle: '<strong>'+equiName+'实时温度</strong>',
		            infoBody: '<p class="my-desc"><span id="last-time"></span><br/><table id="chwin"></table></p>',
		            //基点指向marker的头部位置
		            offset: new AMap.Pixel(-45, -31)
		        }).open(map, marker.getPosition());
			
		    	}
		    
			 }); 
			
			function network() {
				var screenHeight = window.screen.availHeight;
				var screenWidth = window.screen.availWidth;
				var iWidth = screenWidth * 0.875 + "px;";
				var iHeight = screenHeight * 0.82 + "px;";
				var iframe = "<div class=\"wrapper\"><iframe style='width: "+iWidth+"height: "+iHeight+"' src='childrenHtml/graphicDesign/network.html'></iframe></div>";
				$("#content-wrapper").html(iframe);
			}
	</script>
	<!-- 页面地图【结束】 -->


</body>
</html>
