<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="IE=10">
<title>设备管理</title>
<meta
	content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
	name="viewport">
<style type="text/css">
.info_text {
	padding: 10px; . map { height : 100%;
	width: 60%;
	float: left;
}

#right {
	color: #444;
	background-color: #f8f8f8;
	width: 40%;
	float: left;
	height: 100%;
}

#start, #stop, #right input {
	margin: 4px;
	margin-left: 15px;
}

.title {
	width: 100%;
	background-color: #dadada
}

button {
	border: solid 1px;
	margin-left: 15px;
	background-color: #dadafa;
}

.c {
	font-weight: 600;
	padding-left: 15px;
	padding-top: 4px;
}

#lnglat, #address, #nearestJunction, #nearestRoad, #nearestPOI, .title {
	padding-left: 15px;
}
}
</style>
</head>
<body class="hold-transition skin-blue sidebar-mini">
	<section class="content-header">
		<h1>设备信息编辑</h1>
		<ol class="breadcrumb">
			<li><a href="#"><i class="fa fa-dashboard"></i>首页</a></li>
			<li class="active">设备管理</li>
		</ol>
	</section>
	<section class="content">
		<div class="box box-default">
			<div class="box-header">
				<div class="box-tools pull-right">
					<button type="button" class="btn btn-box-tool"
						data-widget="collapse">
						<i class="fa fa-minus"></i>
					</button>
					<button type="button" class="btn btn-box-tool" data-widget="remove"
						onclick="backequlist();">
						<i class="fa fa-remove"></i>
					</button>
				</div>
			</div>
			<div class="box-body">
				<div class="row">
					<div class="col-md-6">
						<form class="form-horizontal">
							<div class="box-body">
								<div class="form-group">
									<label class="col-sm-2 control-label">设备ID</label>
									<div class="col-sm-10">
										<input type="text" class="form-control" id="equipmentId">
									</div>
								</div>
								<div class="form-group">
									<label class="col-sm-2 control-label">设备名称</label>
									<div class="col-sm-10">
										<input type="text" class="form-control" id="equipmentName">
									</div>
								</div>
								<div class="form-group">
									<label class="col-sm-2 control-label">设备类型</label>
									<div class="col-sm-10">
										<select id="type" class="form-control select2">
											<option value="1" selected="selected">开关柜</option>
											<option value="2">干式变压器</option>
											<option value="3">变压器绕组</option>
											<option value="4">环网柜</option>
										</select>
									</div>
								</div>

								<div class="form-group">
									<label class="col-sm-2 control-label">帧结构</label>
									<div class="col-sm-10">
										<input type="text" class="form-control" id="frameStru">
									</div>
								</div>
								<div class="form-group">
									<label class="col-sm-2 control-label">通道数</label>
									<div class="col-sm-10">
										<input type="text" class="form-control" id="numOfCh">
									</div>
								</div>
								<div class="form-group">
									<label class="col-sm-2 control-label">路由器ID</label>
									<div class="col-sm-10">
										<input type="text" class="form-control" id="heartbeatId">
									</div>
								</div>
								<!-- <div class="form-group">
									<label class="col-sm-2 control-label">心跳包名称</label>
									<div class="col-sm-10">
										<input type="text" class="form-control" id="heartbeatName">
									</div>
								</div> -->
							</div>
						</form>
						<div class="col-md-12"
							style="max-height: 370px; overflow-y: auto;">
							<table class="table table-bordered table-striped "
								id="channelTem1">
								<thead>
									<tr>
										<td style="background: #399ad7; color: #f6f6f6;">通道号</td>
										<td style="background: #399ad7; color: #f6f6f6;">光纤位置</td>
										<td style="background: #399ad7; color: #f6f6f6;">温度上限</td>
										<td style="background: #399ad7; color: #f6f6f6;">温度下限</td>
									</tr>
								</thead>
								<tbody id="channelTemList1">

								</tbody>
							</table>
						</div>
						<div class="col-md-12">
							<button class="btn btn-info" id="addBtn"
								style="background: #399ad7;">
								<i class="fa fa-plus"></i> 添加通道
							</button>
						</div>
					</div>
					<div class="col-md-6">
						<form class="form-horizontal">
							<div class="box-body">
								<div class="form-group">
									<label class="col-sm-2 control-label">所属用户</label>
									<div class="col-sm-10">
										<select id="userName" class="form-control select2">
										</select>
									</div>
								</div>
								<div class="form-group">
									<label class="col-sm-2 control-label">经纬度</label>
									<div class="col-sm-10">
										<input type="text" class="form-control" id="lnglat">
									</div>
								</div>
								<div class="form-group">
									<label class="col-sm-2 control-label">地理编码</label>
									<div class="col-sm-10">
										<input type="text" class="form-control" id="adcode">
									</div>
								</div>
								<div class="form-group">
									<label class="col-sm-2 control-label">地址</label>
									<div class="col-sm-10">
										<input type="text" class="form-control" id="address">
									</div>
								</div>
								<div id="containermap" style="height: 550px;" class="map"
									tabindex="0"></div>
							</div>
						</form>
						<div class="fuqusave" id="saves">
							<button class="btn btn-info" onclick="submitEquiInfo();"
								style="background: #399ad7;">保 存</button>
						</div>
					</div>

				</div>
			</div>
		</div>
	</section>
	<script type="text/javascript">
		//地图
		var firstEdit = 0;
		AMapUI.loadUI([ 'misc/PositionPicker' ], function(PositionPicker) {
			var map = new AMap.Map('containermap', {
				zoom : 16,
				center : [ 108.856389, 34.171147 ]
			})
			var positionPicker = new PositionPicker({
				mode : 'dragMap',
				map : map
			});
			positionPicker.on('success', function(positionResult) {
				if (add || firstEdit >= 2) {
					$("#address").val(positionResult.address);
					$("#lnglat").val(positionResult.position);
					$("#adcode").val(
							positionResult.regeocode.addressComponent.adcode);
				}
				firstEdit += 1;
			});
			positionPicker.on('fail', function(positionResult) {
				$("#address").val("");
				$("#lnglat").val("");
			});
			var onModeChange = function(e) {
				positionPicker.setMode(e.target.value)
			}
			positionPicker.start();
			map.panBy(0, 1);
		});
	</script>
	<script type="text/javascript" src="vince/js/bootstable.js"></script>
	<script type="text/javascript">
		$('#channelTem1').SetEditable({
			$addButton : $('#addBtn')
		});
		var globalUserList = [];
		var bu = "<td name=\"buttons\"><div class=\"btn-group pull-right\"><button id=\"bEdit\" type=\"button\" class=\"btn btn-sm btn-default\" onclick=\"rowEdit(this);\"><span class=\"glyphicon glyphicon-pencil\"> </span></button><button id=\"bElim\" type=\"button\" class=\"btn btn-sm btn-default\" onclick=\"rowElim(this);\"><span class=\"glyphicon glyphicon-trash\"> </span></button><button id=\"bAcep\" type=\"button\" class=\"btn btn-sm btn-default\" style=\"display:none;\" onclick=\"rowAcep(this);\"><span class=\"glyphicon glyphicon-ok\"> </span></button><button id=\"bCanc\" type=\"button\" class=\"btn btn-sm btn-default\" style=\"display:none;\" onclick=\"rowCancel(this);\"><span class=\"glyphicon glyphicon-remove\"> </span></button></div></td>"
		if (add) {
			addEquip1();
		} else {
			getEquiEdit1(parami);
		}
		function getUserList() {
			$.ajax({
				url : "user/selectAll",
				type : "post",
				dataType : "json",
				async : false,
				success : function(result) {
					globalUserList = result;

				}
			});
		}
		function getEquiEdit1(param) {
			if (globalData[param].channelTem != undefined) {
				var v = JSON.parse(globalData[param].channelTem);
				var channelTemList = "";
				for (let i = 0; i < v.length; i++) {
					channelTemList += "<tr>";
					channelTemList += "<td>" + v[i][0] + "</td>";
					channelTemList += "<td>" + v[i][1] + "</td>";
					channelTemList += "<td>" + v[i][2] + "</td>";
					channelTemList += "<td>" + v[i][3] + "</td>";
					channelTemList += bu;
					channelTemList += "</tr>"
				}
				$("#channelTemList1").html(channelTemList);
			} else {
				var channelTemList = "";
				channelTemList += "<tr>";
				channelTemList += "<td></td>";
				channelTemList += "<td></td>";
				channelTemList += "<td></td>";
				channelTemList += "<td></td>";
				channelTemList += bu;
				channelTemList += "</tr>"
				$("#channelTemList1").html(channelTemList);
			}
			if (globalUserList == "") {
				getUserList();
			}
			var userHtml = "<option value='"+globalData[param].userId+"' checked>"
					+ globalData[param].userName + "</option>";
			for (let i = 0; i < globalUserList.length; i++) {
				userHtml += "<option  value='"+globalUserList[i].id+"'>"
						+ globalUserList[i].userName + "</option>";
			}
			document.getElementById('type').value = globalData[param].type;
			$("#userName").html(userHtml);
			$("#equipmentId").val(globalData[param].equipmentId);
			$("#equipmentName").val(globalData[param].equipmentName);
			$("#address").val(globalData[param].address);
			$("#adcode").val(globalData[param].adcode);
			$("#lnglat").val(globalData[param].lngLat);
			$("#frameStru").val(globalData[param].frameStru);
			$("#numOfCh").val(globalData[param].numOfCh);
			$("#heartbeatId").val(globalData[param].heartbeatId);
			$("#heartbeatName").val(globalData[param].heartbeatName);
			$("#equipmentId").attr("disabled", "disabled");
		}
		function addEquip1() {
			add = true;
			var channelTemList = "";
			channelTemList += "<tr>";
			channelTemList += "<td>CH1</td>";
			channelTemList += "<td></td>";
			channelTemList += "<td>80</td>";
			channelTemList += "<td>20</td>";
			channelTemList += bu;
			channelTemList += "</tr>";
			$("#channelTemList1").html(channelTemList);
			if (globalUserList == "") {
				getUserList();
			}
			var userHtml = "<option value=\"\" checked>—请选择用户—</option>";
			for (let i = 0; i < globalUserList.length; i++) {
				userHtml += "<option value='"+globalUserList[i].id+"'>"
						+ globalUserList[i].userName + "</option>";
			}
			$("#userName").html(userHtml);

		}
		function backequlist() {
			$("#content-wrapper").load(
					"childrenHtml/equipment/equipmentList.html");
		}
		//提交设备信息表单
		function submitEquiInfo() {
			var mytable = document.getElementById("channelTem1");
			var channelInfos = [];
			for (var i = 1, rows = mytable.rows.length; i < rows; i++) {
				for (var j = 0, cells = mytable.rows[i].cells.length; j < cells - 1; j++) {
					if (!channelInfos[i]) {
						channelInfos[i] = new Array();
					}
					channelInfos[i][j] = mytable.rows[i].cells[j].innerHTML;
				}
			}
			channelInfos.splice(0, 1);
			var res = JSON.stringify(channelInfos);
			var params = {
				"equipmentId" : $("#equipmentId").val(),
				"equipmentName" : $("#equipmentName").val(),
				"type" : $("#type option:selected").val(),
				"userId" : $("#userName").val(),
				"userName" : $("#userName option:selected").text(),
				"address" : $("#address").val(),
				"lngLat" : $("#lnglat").val(),
				"frameStru" : $("#frameStru").val(),
				"numOfCh" : $("#numOfCh").val(),
				"heartbeatName" : $("#heartbeatName").val(),
				"heartbeatId" : $("#heartbeatId").val(),
				"channelTem" : res,
				"adcode" : $("#adcode").val(),
				"add" : add
			};
			if ($("#equipmentId").val() != ""
					|| $("#equipmentId").val() != null) {
				params.equipmentId = $("#equipmentId").val();
			}
			$.ajax({
				url : "equipment/update",
				type : "post",
				data : params,
				dataType : "json",
				success : function(result) {
					if (result.success) {
						alert("操作成功！");
						backequlist();
					} else {
						alert(result.message);
					}
				}
			});
		}

		/*
		Bootstable
		 @description  Javascript library to make HMTL tables editable, using Bootstrap
		 @version 1.1
		 @autor Tito Hinostroza
		 */
		"use strict";
		//Global variables
		var params = null; //Parameters
		var colsEdi = null;
		var newColHtml = '<div class="btn-group pull-right">'
				+ '<button id="bEdit" type="button" class="btn btn-sm btn-default" onclick="rowEdit(this);">'
				+ '<span class="glyphicon glyphicon-pencil" > </span>'
				+ '</button>'
				+ '<button id="bElim" type="button" class="btn btn-sm btn-default" onclick="rowElim(this);">'
				+ '<span class="glyphicon glyphicon-trash" > </span>'
				+ '</button>'
				+ '<button id="bAcep" type="button" class="btn btn-sm btn-default" style="display:none;" onclick="rowAcep(this);">'
				+ '<span class="glyphicon glyphicon-ok" > </span>'
				+ '</button>'
				+ '<button id="bCanc" type="button" class="btn btn-sm btn-default" style="display:none;" onclick="rowCancel(this);">'
				+ '<span class="glyphicon glyphicon-remove" > </span>'
				+ '</button>' + '</div>';
		var colEdicHtml = '<td name="buttons">' + newColHtml + '</td>';

		$.fn.SetEditable = function(options) {
			var defaults = {
				columnsEd : null, //Index to editable columns. If null all td editables. Ex.: "1,2,3,4,5"
				$addButton : null, //Jquery object of "Add" button
				onEdit : function() {
				}, //Called after edition
				onBeforeDelete : function() {
				}, //Called before deletion
				onDelete : function() {
				}, //Called after deletion
				onAdd : function() {
				} //Called when added a new row
			};
			params = $.extend(defaults, options);
			this
					.find('thead tr')
					.append(
							'<th name="buttons" value="操作" style="background: #399ad7;color: #f6f6f6;">操作</th>'); //encabezado vacío
			this.find('tbody tr').append(colEdicHtml);
			var $tabedi = this; //Read reference to the current table, to resolve "this" here.
			//Process "addButton" parameter
			if (params.$addButton != null) {
				//Se proporcionó parámetro
				params.$addButton.click(function() {
					rowAddNew($tabedi.attr("id"));
				});
			}
			//Process "columnsEd" parameter
			if (params.columnsEd != null) {
				//Extract felds
				colsEdi = params.columnsEd.split(',');
			}
		};
		function IterarCamposEdit($cols, tarea) {
			//Itera por los campos editables de una fila
			var n = 0;
			$cols.each(function() {
				n++;
				if ($(this).attr('name') == 'buttons')
					return; //excluye columna de botones
				if (!EsEditable(n - 1))
					return; //noe s campo editable
				tarea($(this));
			});

			function EsEditable(idx) {
				//Indica si la columna pasada está configurada para ser editable
				if (colsEdi == null) { //no se definió
					return true; //todas son editable
				} else { //hay filtro de campos
					//alert('verificando: ' + idx);
					for (var i = 0; i < colsEdi.length; i++) {
						if (idx == colsEdi[i])
							return true;
					}
					return false; //no se encontró
				}
			}
		}
		function FijModoNormal(but) {
			$(but).parent().find('#bAcep').hide();
			$(but).parent().find('#bCanc').hide();
			$(but).parent().find('#bEdit').show();
			$(but).parent().find('#bElim').show();
			var $row = $(but).parents('tr'); //accede a la fila
			$row.attr('id', ''); //quita marca
		}
		function FijModoEdit(but) {
			$(but).parent().find('#bAcep').show();
			$(but).parent().find('#bCanc').show();
			$(but).parent().find('#bEdit').hide();
			$(but).parent().find('#bElim').hide();
			var $row = $(but).parents('tr'); //accede a la fila
			$row.attr('id', 'editing'); //indica que está en edición
		}
		function ModoEdicion($row) {
			if ($row.attr('id') == 'editing') {
				return true;
			} else {
				return false;
			}
		}
		function rowAcep(but) {
			//Acepta los cambios de la edición
			var $row = $(but).parents('tr'); //accede a la fila
			var $cols = $row.find('td'); //lee campos
			if (!ModoEdicion($row))
				return; //Ya está en edición
			//Está en edición. Hay que finalizar la edición
			IterarCamposEdit($cols, function($td) { //itera por la columnas
				var cont = $td.find('input').val(); //lee contenido del input
				$td.html(cont); //fija contenido y elimina controles
			});
			FijModoNormal(but);
			/*  params.onEdit($row); */
		}
		function rowCancel(but) {
			//Rechaza los cambios de la edición
			var $row = $(but).parents('tr'); //accede a la fila
			var $cols = $row.find('td'); //lee campos
			if (!ModoEdicion($row))
				return; //Ya está en edición
			//Está en edición. Hay que finalizar la edición
			IterarCamposEdit($cols, function($td) { //itera por la columnas
				var cont = $td.find('div').html(); //lee contenido del div
				$td.html(cont); //fija contenido y elimina controles
			});
			FijModoNormal(but);
		}
		function rowEdit(but) { //Inicia la edición de una fila
			var $row = $(but).parents('tr'); //accede a la fila
			var $cols = $row.find('td'); //lee campos
			if (ModoEdicion($row))
				return; //Ya está en edición
			//Pone en modo de edición
			IterarCamposEdit(
					$cols,
					function($td) { //itera por la columnas
						var cont = $td.html(); //lee contenido
						var div = '<div style="display: none;">' + cont
								+ '</div>'; //guarda contenido
						var input = '<input class="form-control input-sm"  value="' + cont + '">';
						$td.html(div + input); //fija contenido
					});
			FijModoEdit(but);
		}
		function rowElim(but) { //Elimina la fila actual
			var $row = $(but).parents('tr'); //accede a la fila
			/*    params.onBeforeDelete($row);*/
			$row.remove();
			/*    params.onDelete();*/
		}
		function rowAddNew(tabId) { //Agrega fila a la tabla indicada.
			var $tab_en_edic = $("#" + tabId); //Table to edit
			var $filas = $tab_en_edic.find('tbody tr');
			if ($filas.length == 0) {
				//No hay filas de datos. Hay que crearlas completas
				var $row = $tab_en_edic.find('thead tr'); //encabezado
				var $cols = $row.find('th'); //lee campos
				//construye html
				var htmlDat = '';
				$cols.each(function() {
					if ($(this).attr('name') == 'buttons') {
						//Es columna de botones
						htmlDat = htmlDat + colEdicHtml; //agrega botones
					} else {
						htmlDat = htmlDat + '<td></td>';
					}
				});
				$tab_en_edic.find('tbody').append('<tr>' + htmlDat + '</tr>');
			} else {
				//Hay otras filas, podemos clonar la última fila, para copiar los botones
				var $ultFila = $tab_en_edic.find('tr:last');
				$ultFila.clone().appendTo($ultFila.parent());
				$ultFila = $tab_en_edic.find('tr:last');
				var $cols = $ultFila.find('td'); //lee campos
				$cols.each(function() {
					if ($(this).attr('name') == 'buttons') {
						//Es columna de botones
					} else {
						$(this).html(''); //limpia contenido
					}
				});
			}
			params.onAdd();
		}
		function TableToCSV(tabId, separator) { //Convierte tabla a CSV
			var datFil = '';
			var tmp = '';
			var $tab_en_edic = $("#" + tabId); //Table source
			$tab_en_edic.find('tbody tr').each(
					function() {
						//Termina la edición si es que existe
						if (ModoEdicion($(this))) {
							$(this).find('#bAcep').click(); //acepta edición
						}
						var $cols = $(this).find('td'); //lee campos
						datFil = '';
						$cols.each(function() {
							if ($(this).attr('name') == 'buttons') {
								//Es columna de botones
							} else {
								datFil = datFil + $(this).html() + separator;
							}
						});
						if (datFil != '') {
							datFil = datFil.substr(0, datFil.length
									- separator.length);
						}
						tmp = tmp + datFil + '\n';
					});
			return tmp;
		}
	</script>
	<script src="dist/js/app.min.js"></script>
</body>
</html>

