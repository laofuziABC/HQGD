<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>设备管理——设备新增&编辑</title>
		<meta content="width=device-width, initial-scale=1.0" name="viewport" />
		<meta content="" name="description" />
		<meta content="" name="author" />
		<style type="text/css">
			#outerForm{width: 100%; height: 100%;}
			#outerForm table{width: 100%; height: 100%}
			#outerForm table .normal{width: 100%; height: 40px;}
			#outerForm table .unnormal{width: 100%;}
			#outerForm .normal .info_text{width: 30%; margin: 0px; padding: 0px; font-size: 18px; text-align: right;}
			#outerForm .normal .right_input{width: 100%; height: 40px; margin: 0px; padding: 0px; font-size: 16px; text-align: center; }
			#outerForm select option{font-size: 16px; text-align: center; }
			#outerForm .normal .innerButton{width: 40%; height: 35px; margin: auto 30%; font-size: 16px; background-color: #00B848; color: #FFFFFF; border: 0px; border-radius: 4px;}
			#channelsInfo{width: 90%; margin: 2px auto;}
			#channelsInfo span {width: 125px; height: 90%; font-size: 16px; text-align: center; float: left; border: 1px solid #D3D3D3;}
			#channelsInfo .chan_info{width: 100%; height: 30px;}
			#channelsInfo .chan_info input{width: 125px; height: 29px; padding: 0px;}
			#channelsInfo .chan_info .chan_button{width: 90px; height: 28px; margin: 0px 15px; background-color: #27A9E3; color: #FFFFFF; border: 0px; border-radius: 4px;}
			#outerForm .outerButton{width: 24%; height: 35px; margin: 10px 38%; background-color: #00B848; border: 0px; border-radius: 4px; color: #FFFFFF; font-size: 16px;}
		</style>
	</head>
	<body>
		<div class="content">
			<form action="#" method="post" id="outerForm">
				<table id="equiInfoTable">
					<tr style="display: none;">
						<td class="info_text">设备主键：</td>
						<td><input type="text" class="right_input" id="equipmentId" name="equipmentId"/></td>
						<td class="info_text"></td>
					</tr>
					<tr class="normal">
						<td class="info_text">设备名称<span style="color: red;">*</span>：</td>
						<td><input type="text" class="right_input" placeholder="请输入设备名称" id="equipmentName" name="equipmentName"/></td>
						<td class="info_text"></td>
					</tr>
					<tr class="normal">
						<td class="info_text">所属用户<span style="color: red;">*</span>：</td>
						<td>
							<select class="right_input" id="userId" name="userId">
								<option value="" checked>—请选择用户—</option>
								<option value="1">用户列表-1</option>
								<option value="">用户列表-2</option>
								<option value="">用户列表-3</option>
								<option value="">用户列表-4</option>
								<option value="">用户列表-5</option>
							</select>
						</td>
						<td class="info_text"></td>
					</tr>
					<tr class="normal">
						<td class="info_text">安装地址：</td>
						<td><input type="text" class="right_input" id="address" name="address"/></td>
						<td class="info_text"></td>
					</tr>
					<tr class="normal">
						<td class="info_text">地区编码<span style="color: red;">*</span>：</td>
						<td><input type="text" class="right_input" id="postalCode" name="postalCode"/></td>
						<td class="info_text"></td>
					</tr>
					<tr class="normal">
						<td class="info_text">坐标<span style="color: red;">*</span>：</td>
						<td><input type="text" class="right_input" id="latLon" name="latLon"/></td>
						<td class="info_text"></td>
					</tr>
					<tr class="normal">
						<td class="info_text">帧结构<span style="color: red;">*</span>：</td>
						<td><input type="text" class="right_input" id="frameStru" name="frameStru"/></td>
						<td class="info_text"></td>
					</tr>
					<tr class="normal">
						<td class="info_text">设备通道<span style="color: red;">*</span>：</td>
						<td><input type="button" value="新增通道" onclick="addChannel();" class="innerButton"/></td>
						<td class="info_text"></td>
					</tr>
					<tr class="unnormal">
						<td colspan="3">
							<div id="channelsInfo">
								<div class="chan_info">
									<span>通道名称</span><span>温度上限</span>
									<span>温度下限</span><!-- <span>操作</span> -->
								</div>
							</div>
						</td>
					</tr>
				</table>
				<input type="button" value="提 &nbsp; 交" class="outerButton" onclick="submitEquiInfo();"/>
			</form>
		</div>
		
		<script src="media/js/jquery-1.10.1.min.js" type="text/javascript"></script>
		<script type="text/javascript">
			$(function(){
				//数据回显
				$.ajax({
					url: "equipment/select",
					type: "post",
					data: {"equipmentId": equiId.trim()},
					dataType: "json",
					success: function(result){
						var data = result.data;
						$("#equipmentId").val(data.equipmentId);
						$("#equipmentName").val(data.equipmentName);
						$("#userId").val(data.userId);
						$("#address").val(data.address);
						$("#postalCode").val(data.postalCode);
						$("#latLon").val(data.latLon);
						$("#frameStru").val(data.frameStru);
					}
				});
			});
			
			//新增通道
			var i = 0;
			function addChannel(){
				if(confirm("为设备添加通道？")){
					i++;
					var target = document.getElementById("channelsInfo");
					if(target.style.display == "none"){
						target.style.display = "block";
					}
					var info = "<form id=\"list"+i+"\" class=\"chan_info\">";
					info+="<input type=\"text\" class=\"chan_input\" name= \"channelNum\"/>";
					info+="<input type=\"text\" class=\"chan_input\" name= \"maxTem\"/>";
					info+="<input type=\"text\" class=\"chan_input\" name= \"minTem\"/>";
					info+="<input type=\"button\" value=\"删 &nbsp; 除\" onclick=\"removeThisChannel(' list"+i+" ')\" class=\"chan_button\"/>";
					info+="</form>";
					$("#channelsInfo").append(info);
				}
			}
			//移除通道
			function removeThisChannel(param){
				if(confirm("是否删除"+param)){
					$("#"+param.trim()).remove();
				}
			}
			//提交设备信息表单
			function submitEquiInfo(){
				var target = document.getElementsByClassName("chan_info");
				//封装通道名称、温度最大值、温度最小值
				var channelNums=[];
				var maxTems=[];
				var minTems=[];
				for(let i=1; i<target.length; i++){
					var chanParam = $("#list"+i).serialize();
					var temp = chanParam.split("&");
					let num0 = temp[0].indexOf("=")+1;
					let obj0 = temp[0].substring(num0);
					channelNums.push(obj0);
					let num1 = temp[1].indexOf("=")+1;
					let obj1 = temp[1].substring(num1);
					maxTems.push(obj1);
					let num2 = temp[2].indexOf("=")+1;
					let obj2 = temp[2].substring(num2);
					minTems.push(obj2);
				}
				alert(channelNums+"\n"+maxTems+"\n"+minTems);
				var params={
					"equipmentId": $("#equipmentId").val(),
					"equipmentName": $("#equipmentName").val(),
					"userId": $("#userId").val(),
					"region": $("#region").val(),
					"uniqueCode": $("#uniqueCode").val(),
					"channelNum": channelNums,
					"maxTem": maxTems,
					"minTem": minTems
				};
				$.ajax({
					url: "equipment/setParam",
					type: "post",
					data: params,
					dataType: "json",
					success: function(result){
						if(result.message == "true"){ alert("添加成功！"); }
						else{ alert("添加失败！"); }
					}
				});
				closeModal();
				getEquipmentList();
			}
		</script>
	</body>
</html>